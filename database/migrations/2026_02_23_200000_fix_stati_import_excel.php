<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Fix stati fasi importate da Excel (estratto_foglio_tutto):
     * - stato 3 (Terminato) -> 4 (Consegnato)
     * - stato 2 (Avviato) -> 3 (Terminato)
     * - stato 1 (Pronto) -> 2 (Avviato)
     * ORDINE IMPORTANTE: prima 3->4, poi 2->3, poi 1->2
     */
    public function up(): void
    {
        $commesse = [
            '0063866-25', '0063867-25', '0065764-25', '0065899-25', '0065932-25',
            '0065959-25', '0065961-25', '0066026-26', '0066035-26', '0066055-26',
            '0066056-26', '0066057-26', '0066059-26', '0066111-26', '0066123-26',
            '0066126-26', '0066128-26', '0066146-26', '0066154-26', '0066186-26',
            '0066187-26', '0066188-26', '0066198-26', '0066201-26', '0066207-26',
            '0066208-26', '0066209-26', '0066211-26', '0066220-26', '0066221-26',
            '0066222-26', '0066223-26', '0066237-26', '0066243-26', '0066264-26',
            '0066273-26', '0066277-26', '0066291-26', '0066297-26', '0066298-26',
            '0066300-26', '0066311-26', '0066315-26', '0066318-26', '0066330-26',
            '0066333-26', '0066335-26', '0066336-26', '0066337-26', '0066338-26',
            '0066339-26', '0066340-26', '0066341-26', '0066342-26', '0066343-26',
            '0066344-26', '0066345-26', '0066346-26', '0066347-26', '0066348-26',
            '0066349-26', '0066363-26', '0066364-26', '0066366-26', '0066368-26',
            '0066370-26', '0066372-26', '0066378-26', '0066379-26', '0066380-26',
            '0066381-26', '0066383-26', '0066384-26', '0066385-26', '0066386-26',
            '0066387-26', '0066388-26', '0066389-26', '0066392-26', '0066393-26',
            '0066394-26', '0066395-26', '0066398-26', '0066399-26', '0066400-26',
            '0066402-26', '0066409-26', '0066410-26', '0066411-26', '0066415-26',
            '0066417-26', '0066418-26', '0066419-26', '0066420-26', '0066421-26',
            '0066422-26', '0066423-26', '0066424-26', '0066426-26', '0066427-26',
            '0066428-26', '0066432-26', '0066433-26', '0066434-26', '0066436-26',
            '0066437-26', '0066446-26', '0066455-26', '0066456-26', '0066458-26',
            '0066459-26', '0066460-26', '0066461-26', '0066462-26', '0066463-26',
            '0066467-26', '0066468-26', '0066469-26', '0066470-26', '0066475-26',
            '0066477-26', '0066478-26', '0066480-26', '0066481-26', '0066482-26',
            '0066483-26', '0066485-26', '0066487-26', '0066489-26', '0066494-26',
            '0066495-26', '0066508-26', '0066518-26', '0066519-26', '0066522-26',
            '0066525-26', '0066527-26', '0066532-26', '0066535-26', '0066540-26',
            '0066541-26', '0066542-26', '0066543-26', '0066544-26', '0066545-26',
            '0066546-26', '0066547-26', '0066548-26', '0066549-26', '0066552-26',
            '0066561-26',
        ];

        foreach (array_chunk($commesse, 100) as $chunk) {
            $placeholders = implode(',', array_fill(0, count($chunk), '?'));

            DB::update(
                "UPDATE ordine_fasi SET stato = '4'
                 WHERE stato = '3'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );

            DB::update(
                "UPDATE ordine_fasi SET stato = '3'
                 WHERE stato = '2'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );

            DB::update(
                "UPDATE ordine_fasi SET stato = '2'
                 WHERE stato = '1'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );
        }
    }

    public function down(): void
    {
        $commesse = [
            '0063866-25', '0063867-25', '0065764-25', '0065899-25', '0065932-25',
            '0065959-25', '0065961-25', '0066026-26', '0066035-26', '0066055-26',
            '0066056-26', '0066057-26', '0066059-26', '0066111-26', '0066123-26',
            '0066126-26', '0066128-26', '0066146-26', '0066154-26', '0066186-26',
            '0066187-26', '0066188-26', '0066198-26', '0066201-26', '0066207-26',
            '0066208-26', '0066209-26', '0066211-26', '0066220-26', '0066221-26',
            '0066222-26', '0066223-26', '0066237-26', '0066243-26', '0066264-26',
            '0066273-26', '0066277-26', '0066291-26', '0066297-26', '0066298-26',
            '0066300-26', '0066311-26', '0066315-26', '0066318-26', '0066330-26',
            '0066333-26', '0066335-26', '0066336-26', '0066337-26', '0066338-26',
            '0066339-26', '0066340-26', '0066341-26', '0066342-26', '0066343-26',
            '0066344-26', '0066345-26', '0066346-26', '0066347-26', '0066348-26',
            '0066349-26', '0066363-26', '0066364-26', '0066366-26', '0066368-26',
            '0066370-26', '0066372-26', '0066378-26', '0066379-26', '0066380-26',
            '0066381-26', '0066383-26', '0066384-26', '0066385-26', '0066386-26',
            '0066387-26', '0066388-26', '0066389-26', '0066392-26', '0066393-26',
            '0066394-26', '0066395-26', '0066398-26', '0066399-26', '0066400-26',
            '0066402-26', '0066409-26', '0066410-26', '0066411-26', '0066415-26',
            '0066417-26', '0066418-26', '0066419-26', '0066420-26', '0066421-26',
            '0066422-26', '0066423-26', '0066424-26', '0066426-26', '0066427-26',
            '0066428-26', '0066432-26', '0066433-26', '0066434-26', '0066436-26',
            '0066437-26', '0066446-26', '0066455-26', '0066456-26', '0066458-26',
            '0066459-26', '0066460-26', '0066461-26', '0066462-26', '0066463-26',
            '0066467-26', '0066468-26', '0066469-26', '0066470-26', '0066475-26',
            '0066477-26', '0066478-26', '0066480-26', '0066481-26', '0066482-26',
            '0066483-26', '0066485-26', '0066487-26', '0066489-26', '0066494-26',
            '0066495-26', '0066508-26', '0066518-26', '0066519-26', '0066522-26',
            '0066525-26', '0066527-26', '0066532-26', '0066535-26', '0066540-26',
            '0066541-26', '0066542-26', '0066543-26', '0066544-26', '0066545-26',
            '0066546-26', '0066547-26', '0066548-26', '0066549-26', '0066552-26',
            '0066561-26',
        ];

        foreach (array_chunk($commesse, 100) as $chunk) {
            $placeholders = implode(',', array_fill(0, count($chunk), '?'));

            DB::update(
                "UPDATE ordine_fasi SET stato = '1'
                 WHERE stato = '2'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );

            DB::update(
                "UPDATE ordine_fasi SET stato = '2'
                 WHERE stato = '3'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );

            DB::update(
                "UPDATE ordine_fasi SET stato = '3'
                 WHERE stato = '4'
                 AND ordine_id IN (SELECT id FROM ordini WHERE commessa IN ($placeholders))",
                $chunk
            );
        }
    }
};
